<Overlay
    @onLoad={{this.setOverlayContext}}
    @onOpen={{this.onOpen}}
    @onClose={{this.onClose}}
    @onToggle={{this.onToggle}}
    @position="right"
    @noBackdrop={{true}}
    @fullHeight={{true}}
    @isResizeble={{true}}
    @width="570px"
    @overlayClass="place-form-panel"
>
    <Overlay::Header
        @title={{if this.place.public_id this.place.address (t "fleet-ops.component.place-form-panel.place")}}
        @status={{this.place.public_id}}
        @hideStatusDot={{true}}
        @titleWrapperClass="flex-col leading-5"
    >
        <div class="flex flex-1 justify-end">
            <Button
                {{!-- @icon={{if this.place.id "save" "check"}}
                @type="primary"
                @text={{if this.place.id (t "fleet-ops.component.place-form-panel.save-place") (t "fleet-ops.component.place-form-panel.create-place")}}
                @wrapperClass="mr-2" --}}
                @icon={{if this.place.id "save" "check"}}
                @type="primary"
                @text={{if this.place.id (t "fleet-ops.component.place-form-panel.save-place") (t "fleet-ops.component.place-form-panel.create-place")}}
                @onClick={{perform this.save}}
                @isLoading={{this.save.isRunning}}
                @wrapperClass="mr-2"
                @permission={{this.savePermission}}
            />
            <Button
                @type="default"
                @icon="times"
                @helpText={{if this.place.id (t "fleet-ops.component.place-form-panel.cancel-edit-place") (t "fleet-ops.component.place-form-panel.cancel-new-place")}}
                @onClick={{this.onPressCancel}}
            />
        </div>
    </Overlay::Header>

    <Overlay::Body @wrapperClass="new-service-rate-overlay-body px-4 space-y-4 pt-4">
        {{#let (cannot this.savePermission) as |unauthorized|}}
            <div class="flex-1 space-y-4">
                <div class="grid grid-cols-3 gap-1 text-xs dark:text-gray-100">

                  <div class="input-group col-span-3">
                      <div class="flex">
                          <label for="place_type_ember38">Place Type</label>
                      </div>
                      <input type="hidden" name="selelcted-place" value="{{this.place.type}}">

                      <select id="place-type" name="place_type" class="block w-full mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <optgroup label="Transit Hubs">
                          <option value="Bus Station">Bus Station (Local)</option>
                          <option value="Railway Station">Railway Station</option>
                          <option value="Ferry Terminal">Ferry Terminal</option>
                          <option value="Taxi Stand">Taxi Stand</option>
                          <option value="Airport">Airport</option>
                          <option value="Seaport">Seaport</option>
                          <option value="Bus Terminal">Bus Terminal (Interstate and International)</option>
                          <option value="Car Rental Location">Car Rental Location</option>
                          <option value="Bicycle Sharing Station">Bicycle Sharing Station</option>
                          <option value="Korope Park">Korope (mini bus) Park</option>
                          <option value="Heliport">Heliport</option>
                          <option value="Drone port">Drone port</option>
                        </optgroup>

                        <optgroup label="Logistics & Travel Points">
                          <option value="Pickup/Drop-off Point">Pickup/Drop-off Point</option>
                          <option value="Border Crossing">Border Crossing</option>
                          <option value="Parking Lot/Garage">Parking Lot/Garage</option>
                          <option value="Service Station">Service Station</option>
                          <option value="Cargo Terminal">Cargo Terminal</option>
                          <option value="Rest Stops/Service Area">Rest Stops/Service Area</option>
                          <option value="Courier Service Depot">Courier Service Depot</option>
                          <option value="Freight Forwarding Center">Freight Forwarding Center</option>
                          <option value="Warehousing Location">Warehousing Location</option>
                          <option value="Truck Park">Truck Park</option>
                        </optgroup>

                        <optgroup label="Commercial & Accommodation">
                          <option value="Hotel and Accommodation">Hotel and Accommodation</option>
                          <option value="Serviced Apartment">Serviced Apartment</option>
                          <option value="Conference Center">Conference Center</option>
                          <option value="Guesthouse">Guesthouse</option>
                          <option value="Event Space">Event Space</option>
                          <option value="Serviced Office">Serviced Office</option>
                        </optgroup>

                        <optgroup label="Retail & Service Locations">
                          <option value="Storefront">Storefront</option>
                          <option value="Food Takeaway">Food Takeaway</option>
                          <option value="Restaurant">Restaurant</option>
                          <option value="Supermarket">Supermarket</option>
                          <option value="Auto Repair Shop">Auto Repair Shop</option>
                          <option value="Laundromat">Laundromat</option>
                          <option value="Beauty Salon">Beauty Salon</option>
                          <option value="Barber Shop">Barber Shop</option>
                          <option value="Pharmacy">Pharmacy</option>
                          <option value="Gym">Gym</option>
                          <option value="Dentist">Dentist</option>
                          <option value="Optician">Optician</option>
                          <option value="Physiotherapist">Physiotherapist</option>
                          <option value="Tailor">Tailor</option>
                        </optgroup>

                        <optgroup label="Emergency Services">
                          <option value="Police Station">Police Station</option>
                          <option value="Clinic">Clinic</option>
                          <option value="Hospital">Hospital</option>
                          <option value="Fire Station">Fire Station</option>
                          <option value="Paediatrics">Paediatrics</option>
                        </optgroup>

                        <optgroup label="Education">
                          <option value="Schools">Schools</option>
                          <option value="Universities">Universities</option>
                          <option value="Daycares and Nurseries">Daycares and Nurseries</option>

                        </optgroup>
                      </select>

                  <style type="text/css">
                      select#place-type {
                            background-color: rgb(55 65 81);
                            border: 1px solid #111827;
                        }
                  </style>
                  </div>


                    <InputGroup @name={{t "fleet-ops.common.name"}} @wrapperClass="col-span-2">
                        <Input @value={{this.place.name}} @type="text" class="w-full form-input place-name" placeholder={{t "fleet-ops.common.name"}} disabled={{unauthorized}} />
                    </InputGroup>

                  
                    <InputGroup @name={{t "fleet-ops.component.place-form-panel.street-1"}} @value={{this.place.street1}} @wrapperClass="col-span-3 address_section_hidden">

                       <AutocompleteInput
                            @value={{this.place.street1}}
                            @fetchUrl="places/lookup"
                            @onSelect={{this.onAutocomplete}}
                            disabled={{unauthorized}}
                            placeholder={{t "fleet-ops.component.place-form-panel.street-1"}}
                            class="w-full placestreet1"
                            as |result|
                        >
                            {{result.address}}
                        </AutocompleteInput>


                    </InputGroup>

                    {{!-- Toggle Button --}}
                    <div class="col-span-3 toggle-button-container">
                        <button type="button" class="toggle-button" style="margin-bottom:10px;">Expert Settings</button>
                    </div>
                    <!-- All Input Groups are initially hidden -->
                    <InputGroup
                        @name={{t "fleet-ops.component.place-form-panel.street-2"}}
                        @autocomplete="nope"
                        @value={{this.place.street2}}
                        @wrapperClass="col-span-3 placestreet2 expert-settings-group"
                        @disabled={{unauthorized}}
                    />
                    <InputGroup
                        @name={{t "fleet-ops.component.place-form-panel.neighborhood"}}
                        @autocomplete="nope"
                        @value={{this.place.neighborhood}}
                        @disabled={{unauthorized}}
                        @wrapperClass="neighborhood_get_value expert-settings-group"
                    />
                    <InputGroup
                        @name={{t "fleet-ops.component.place-form-panel.building"}}
                        @autocomplete="nope"
                        @value={{this.place.building}}
                        @disabled={{unauthorized}}
                        @wrapperClass="building_get_value expert-settings-group"
                    />
                    <InputGroup
                        @name={{t "fleet-ops.component.place-form-panel.security-code"}}
                        @autocomplete="nope"
                        @value={{this.place.security_access_code}}
                        @disabled={{unauthorized}}
                        @wrapperClass="security_code_get_value expert-settings-group"
                    />
                    <InputGroup
                        @name={{t "fleet-ops.component.place-form-panel.postal-code"}}
                        @autocomplete="nope"
                        @value={{this.place.postal_code}}
                        @disabled={{unauthorized}}
                        @wrapperClass="postal_code_select expert-settings-group"
                    />
                    <input type="hidden" name="place-city" value="{{this.place.city}}">
                    <InputGroup @name={{t "fleet-ops.common.city"}} @wrapperClass="expert-settings-group">
                        <div class="fleetbase-model-select fleetbase-power-select ember-model-select city_section_select">
                            <PowerSelect
                                @options={{this.cityOptions}} 
                                @selected={{this.place.city}}
                                @onChange={{fn (mut this.place.city)}}
                                @placeholder={{t "fleet-ops.common.city"}}
                                @triggerClass="form-select form-input"
                                @disabled={{cannot this.savePermission}}
                                as |city|
                            >
                                {{city.name}}
                            </PowerSelect>
                        </div>
                    </InputGroup>

                    <InputGroup
                        @name={{t "fleet-ops.component.place-form-panel.state"}}
                        @autocomplete="nope"
                        @value={{this.place.province}}
                        @disabled={{unauthorized}}
                        @wrapperClass="state_get_value expert-settings-group"
                    />
                    <InputGroup @name={{t "fleet-ops.common.country"}} @wrapperClass="col-span-2 country_section_select expert-settings-group">
                        <CountrySelect
                            class="w-full form-input form-select form-datalist"
                            @value={{this.place.country}}
                            @onChange={{this.onCountryChange}}
                            @placeholder={{t "fleet-ops.common.country"}}
                            @disabled={{unauthorized}}
                        />
                    </InputGroup>
                    <InputGroup
                        @name={{t "fleet-ops.common.coordinates"}}
                        @wrapperClass="col-span-2 lat_long_field expert-settings-group"
                    >
                        <CoordinatesInput
                            @value={{this.place.location}}
                            @onChange={{this.updatePlaceCoordinates}}
                            @onGeocode={{this.onAutocomplete}}
                            @onUpdatedFromMap={{this.onReverseGeocode}}
                            @onInit={{this.setCoordinatesInput}}
                            @disabled={{unauthorized}}
                        />
                    </InputGroup>
                    <div class="col-span-2 phnblank"></div>
                    <InputGroup @name={{t "fleet-ops.common.phone"}}>
                        <PhoneInput @value={{this.place.phone}} @autocomplete="nope" @onInput={{this.phone}} disabled={{unauthorized}} class="form-input w-full placeNumber" />
                    </InputGroup>
                    <InputGroup @name={{t "fleet-ops.common.email"}} @wrapperClass="col-span-2">
                        <Input @type="email" class="w-full form-input place-email" placeholder={{t "fleet-ops.common.email"}} disabled={{unauthorized}} />
                    </InputGroup>
                </div>

                <ContentPanel @title={{t "fleet-ops.component.avatar-picker.avatar"}} @open={{true}} @pad={{true}} @panelBodyClass="bg-white dark:bg-gray-800 avatar_image_changes">
                <AvatarPicker @model={{this.place}} @defaultAvatar={{config "defaultValues.placeAvatar"}} @disabled={{unauthorized}} />
                </ContentPanel>
            </div>
        {{/let}}

        <Spacer @height="300px" />
    </Overlay::Body>
</Overlay>
<style type="text/css">
    .avatar_image_changes .fleetbase-model-select.fleetbase-power-select.ember-model-select.w-60 {
        display: none;
    }
   .avatar_image_changes .select_avatar_type {
        display: none;
    }
</style>


<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDGjeEtV0FnjiB_zrUuBgeA6d7L5JmFH2Q&libraries=places&callback=initialize"></script>
<script type="text/javascript">
function initialize() {
    const acInputs = document.getElementsByClassName("autocomplete_search_by_api");

    for (let i = 0; i < acInputs.length; i++) {
        const autocomplete = new google.maps.places.Autocomplete(acInputs[i]);
        autocomplete.inputId = acInputs[i].id;

        // Event listener for when a place is selected from the autocomplete dropdown
        google.maps.event.addListener(autocomplete, 'place_changed', function () {
            const place = autocomplete.getPlace();
            populateFieldsFromPlace(place);
        });

        // Keyup event to detect when the user types an address
        $(acInputs[i]).on('keyup', function () {
            const searchAddress = $(this).val().trim();
            if (searchAddress) {
                fetchGeolocationData(searchAddress);
            }
        });
    }
}

// Helper function to populate fields from the Place object
function populateFieldsFromPlace(place) {
    if (place && place.geometry) {
        const latitude = place.geometry.location.lat();
        const longitude = place.geometry.location.lng();

        let country = '';
        let city = '';
        let postalCode = '';
        let neighborhood = '';
        let building = '';
        let securityCode = '';
        let state = '';

        place.address_components.forEach(component => {
            const types = component.types;
            if (types.includes("country")) country = component.long_name;
            if (types.includes("country")) countryCode = component.short_name;
            if (types.includes("locality") || types.includes("administrative_area_level_1")) city = component.long_name;
            if (types.includes("postal_code")) postalCode = component.long_name;
            if (types.includes("neighborhood")) neighborhood = component.long_name;
            if (types.includes("premise")) building = component.long_name;
            if (types.includes("administrative_area_level_1")) state = component.long_name;
            if (types.includes("postal_code_suffix")) securityCode = component.long_name;
        });

        // Populate fields
        $('.coordinates-input .ember-text-field:nth-child(1)').val(latitude);
        $('.coordinates-input .ember-text-field:nth-child(2)').val(longitude);
        $('.city_section_select .ember-power-select-selected-item').text(city);
        $('.country_section_select .ember-power-select-selected-item span:nth-child(2)').text(country);
        $('.country_section_select input.ember-text-field')
        .val(countryCode)          
        .data('county', countryCode); 
        $('.postal_code_select .ember-text-field').val(postalCode);
        $('.neighborhood_get_value .ember-text-field').val(neighborhood);
        $('.building_get_value .ember-text-field').val(building);
        $('.security_code_get_value .ember-text-field').val(securityCode);
        $('.state_get_value').val(state);

        console.log(`Country: ${country}, City: ${city}, Latitude: ${latitude}, Longitude: ${longitude}`);
    } else {
        console.error("Place has no geometry.");
    }
}

// Function to fetch geolocation data based on typed address
function fetchGeolocationData(searchAddress) {
    fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(searchAddress)}&key=AIzaSyDGjeEtV0FnjiB_zrUuBgeA6d7L5JmFH2Q`)
        .then(response => response.json())
        .then(data => {
            if (data.status === "OK" && data.results[0]) {
                populateFieldsFromPlace(data.results[0]);
            } else {
                console.error("No results found for this address.");
            }
        })
        .catch(error => {
            console.error("Error fetching geolocation data:", error);
        });
}
</script>


<script type="text/javascript">
$(document).ready(function() {

    $("label[for^='street1_']").text("Address");
    $("input[placeholder='Street 1']").attr("placeholder", "Address");

    $('.expert-settings-group').hide();
    $('.phnblank').hide();
    $('.toggle-button').on('click', function() {
        $('.expert-settings-group').show();
        $('.phnblank').show();
        $(this).hide();
    });

    const placeImages = {
        "Bus Station": "/images/Bus_Station.png",
        "Railway Station": "/images/Railway_Station.png",
        "Ferry Terminal": "/images/Ferry_Terminal.png",
        "Taxi Stand": "/images/Taxi_Stand.png",
        "Airport": "/images/Airport.png",
        "Seaport": "/images/Seaport.png",
        "Bus Terminal": "/images/Private_Bus_Terminal.png",
        "Car Rental Location": "/images/Car_Rental_Location.png",
        "Bicycle Sharing Station": "/images/Bicycle_Sharing_Station.png",
        "Korope Park": "/images/minibus.png",
        "Heliport": "/images/heliport.png",
        "Drone port": "/images/drone.png",
        "Pickup/Drop-off Point": "/images/PickupDrop-off-Point.png",
        "Border Crossing": "/images/Border_Crossing.png",
        "Parking Lot/Garage": "/images/Parking_Lot_Garage.png",
        "Service Station": "/images/Service_Station.png",
        "Cargo Terminal": "/images/Cargo_Terminal.png",
        "Rest Stops/Service Area": "/images/Rest_Stops_Service_Area.png",
        "Courier Service Depot": "/images/Courier_Service_Depot.png",
        "Freight Forwarding Center": "/images/Freight_Forwarding_Center.png",
        "Warehousing Location": "/images/Warehousing_Location.png",
        "Truck Park": "/images/Truck_Park.png",
        "Hotel and Accommodation": "/images/Hotel_and_Accomodation.png",
        "Serviced Apartment": "/images/Serviced_Apartment.png",
        "Conference Center": "/images/Conference_Center.png",
        "Guesthouse": "/images/Guesthouse.png",
        "Event Space": "/images/event_space.png",
        "Serviced Office": "/images/Serviced_Office.png",
        "Storefront": "/images/Storefront.png",
        "Food Takeaway": "/images/Food_Takeaway.png",
        "Restaurant": "/images/Restaurant.png",
        "Supermarket": "/images/Supermarket.png",
        "Auto Repair Shop": "/images/Auto_Repair_Shop.png",
        "Laundromat": "/images/Laundromat.png",
        "Beauty Salon": "/images/Beauty_Salon.png",
        "Barber Shop": "/images/Barber_Shop.png",
        "Pharmacy": "/images/Pharmacy.png",
        "Gym": "/images/Gym.png",
        "Police Station": "/images/Police_Station.png",
        "Clinic": "/images/Clinic.png",
        "Hospital": "/images/Hospital.png",
        "Fire Station": "/images/Fire_Station.png",
        "Dentist": "/images/Dentist.png",
        "Optician": "/images/Optician.png",
        "Physiotherapist": "/images/Physiotherapist.png",
        "Tailor": "/images/Tailor.png",
        "Paediatrics": "/images/Paediatrics.png",
        "Schools": "/images/Schools.png",
        "Universities": "/images/Universities.png",
        "Daycares and Nurseries": "/images/Daycares-and-Nurseries.png",
    };
    let selectedPlace = $("input[name='selelcted-place']").val() || "Bus Station";
    $("#place-type").val(selectedPlace);
    updateAvatarImage(selectedPlace);

    // Update avatar image when place type changes
    $("#place-type").on("change", function () {
        const placeType = $(this).val();
        updateAvatarImage(placeType);
    });
    function updateAvatarImage(placeType) {
        const imagePath = placeImages[placeType];
        $(".avatar_image_changes .flb--img").attr("src", imagePath);
    }

    var city = $('input[name="place-city"]').val()
    if (city && city.trim() !== '') {
        $('.city_section_select .ember-power-select-selected-item').text(city);
    }

    let urlParts = window.location.href.split('/');
    let placeId = urlParts[urlParts.length - 1];
    if (placeId.includes('?')) {
        placeId = placeId.split('?')[0];
    } else if (placeId.includes('#')) {
        placeId = placeId.split('#')[0]; 
    }
    console.log(placeId);
    if (placeId && placeId.startsWith('place_')) {
        fetch(`https://african.land/travo_api/get_place_api.php?place_id=${placeId}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.data && data.data.email) {
                    $('.place-email').val(data.data.email);
                } else {
                    console.error('No email found for this place.');
                }
            })
            .catch(error => {
                console.error('Error fetching place details:', error);
            });
    }

});
</script>


